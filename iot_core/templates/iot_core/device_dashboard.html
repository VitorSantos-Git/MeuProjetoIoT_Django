{% extends "admin/base_site.html" %} {# Extendendo seu base_site.html customizado #}
{% load static %}

{% block title %}Controle de IoT{% endblock %}

{% block branding %}
    <h1 id="site-name">Controle de Dispositivos IoT</h1>
{% endblock %}

{% block content %}
    <style>
        /* Estilos para a dashboard */
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Colunas responsivas */
            gap: 20px;
            margin-top: 20px;
        }

        .device-card {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 20px;
            text-align: center;
        }

        .device-card h3 {
            margin-top: 0;
            color: #333;
        }

        .device-status {
            font-size: 1.2em;
            font-weight: bold;
            margin: 15px 0;
            padding: 8px;
            border-radius: 5px;
            display: inline-block; /* Para o background se ajustar ao texto */
            min-width: 100px;
        }

        .status-ligado {
            background-color: #e6ffe6; /* Verde claro */
            color: #28a745; /* Verde escuro */
            border: 1px solid #28a745;
        }

        .status-desligado {
            background-color: #ffe6e6; /* Vermelho claro */
            color: #dc3545; /* Vermelho escuro */
            border: 1px solid #dc3545;
        }

        .device-actions button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .device-actions .btn-on {
            background-color: #28a745; /* Verde */
            color: white;
        }
        .device-actions .btn-on:hover {
            background-color: #218838;
        }

        .device-actions .btn-off {
            background-color: #dc3545; /* Vermelho */
            color: white;
        }
        .device-actions .btn-off:hover {
            background-color: #c82333;
        }

        .device-actions .btn-delete {
            background-color: #6c757d; /* Cinza */
            color: white;
            font-size: 0.8em;
            padding: 5px 10px;
            margin-top: 10px;
        }
        .device-actions .btn-delete:hover {
            background-color: #5a6268;
        }

        /* Estilos para o formulário de adicionar dispositivo */
        .add-device-form {
            background-color: #f8f8f8;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
        }
        .add-device-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .add-device-form input[type="text"],
        .add-device-form textarea,
        .add-device-form input[type="number"] { /* Adicionado para input de número */
            width: calc(100% - 20px);
            padding: 8px 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .add-device-form button[type="submit"] {
            background-color: #007bff; /* Azul padrão */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .add-device-form button[type="submit"]:hover {
            background-color: #0056b3;
        }

        .messages {
            list-style: none;
            padding: 0;
            margin: 20px 0 0 0;
        }
        .messages li {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .messages .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .messages .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .messages .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

    </style>

    <h1>Gerenciar Dispositivos IoT</h1>

    {# Mensagens do Django #}
    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="device-grid">
        {% for device in devices %} {# 'devices' agora são objetos Dispositivo #}
        <div class="device-card" id="device-{{ device.id }}">
            <h3>{{ device.nome }} (IP: {{ device.ip_endereco }}:{{ device.porta }})</h3> {# Exibe o nome, IP e porta do Dispositivo #}
            <p>{{ device.descricao }}</p>
            <div class="device-status">
                <span id="status-{{ device.id }}" class="{% if device.current_state.is_on %}status-ligado{% else %}status-desligado{% endif %}">
                    {{ device.current_state|default_if_none:"N/A"|yesno:"LIGADO,DESLIGADO" }}
                </span>
                <br>
                <small>Última atualização: <span id="last-updated-{{ device.id }}">{{ device.current_state.last_updated|date:"d/m/Y H:i:s" }}</span></small>
            </div>
            <div class="device-actions">
                {# Use data-device-pk para enviar a PK do Dispositivo para a view #}
                <button class="btn-on" data-device-pk="{{ device.id }}">ON</button>
                <button class="btn-off" data-device-pk="{{ device.id }}">OFF</button>
                <form action="{% url 'delete_device' device.id %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn-delete" onclick="return confirm('Tem certeza que deseja remover {{ device.nome }}?');">Remover</button>
                </form>
            </div>
        </div>
        {% empty %}
        <p>Nenhum dispositivo IoT cadastrado. Adicione um abaixo!</p>
        {% endfor %}
    </div>

    <div class="add-device-form">
        <h2>Adicionar Novo Dispositivo IoT</h2>
        <form action="{% url 'add_device' %}" method="post">
            {% csrf_token %}
            {{ form.as_p }} {# Renderiza os campos do formulário como parágrafos #}
            <button type="submit">Adicionar Dispositivo</button>
        </form>
    </div>

    {# Script JavaScript para lidar com o envio de comandos via AJAX #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sendCommandButtons = document.querySelectorAll('.device-actions button:not(.btn-delete)');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            sendCommandButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const devicePk = this.dataset.devicePk; // Agora pegamos o PK
                    const command = this.textContent.trim(); // 'ON' ou 'OFF'

                    fetch('{% url "send_command" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrfToken
                        },
                        body: `device_pk=${devicePk}&command=${command}` // Envia o PK
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const statusElement = document.getElementById(`status-${devicePk}`);
                            const lastUpdatedElement = document.getElementById(`last-updated-${devicePk}`);
                            
                            if (data.is_on) {
                                statusElement.textContent = 'LIGADO';
                                statusElement.className = 'device-status status-ligado';
                            } else {
                                statusElement.textContent = 'DESLIGADO';
                                statusElement.className = 'device-status status-desligado';
                            }
                            // Atualizar a hora da última atualização
                            const now = new Date();
                            const formattedDate = `${('0' + now.getDate()).slice(-2)}/${('0' + (now.getMonth() + 1)).slice(-2)}/${now.getFullYear()} ${('0' + now.getHours()).slice(-2)}:${('0' + now.getMinutes()).slice(-2)}:${('0' + now.getSeconds()).slice(-2)}`;
                            lastUpdatedElement.textContent = formattedDate;

                            console.log(`Comando ${command} para dispositivo PK=${devicePk} enviado com sucesso!`);
                        } else {
                            alert('Erro ao enviar comando: ' + data.message);
                            console.error('Erro:', data.message);
                        }
                    })
                    .catch(error => {
                        alert('Ocorreu um erro na requisição: ' + error);
                        console.error('Erro na requisição:', error);
                    });
                });
            });
        });
    </script>
{% endblock %}

{% block nav-global %}{% endblock %}