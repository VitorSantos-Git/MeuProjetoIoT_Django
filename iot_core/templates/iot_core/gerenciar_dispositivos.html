{% extends 'base.html' %} {# <--- ESSA LINHA DIZ QUE ESTE TEMPLATE HERDA DE base.html #}
{% load iot_filters %}   {# Mantenha esta linha para carregar seus filtros customizados #}

{% block title %}Gerenciar Dispositivos IoT{% endblock %} {# Define o título para esta página #}

{% block content %} {# <--- TUDO AQUI DENTRO SERÁ COLOCADO NO 'main-content' DO base.html #}

    <h1>Gerenciar Dispositivos IoT</h1>

    {# As mensagens já estão no base.html, então REMOVA ESTE BLOCO SE ESTIVER AQUI #}
    {#
    <ul class="messages">
        {% if messages %}
            {% for message in message %}
                <li {% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        {% endif %}
    </ul>
    #}

    {% if dispositivos %}
        {% for dispositivo in dispositivos %}
            <div class="device-card">
                <h3>{{ dispositivo.nome }}</h3>
                <p><strong>Descrição:</strong> {{ dispositivo.descricao|default:"N/A" }}</p>
                <p><strong>Endereço IP:</strong> {{ dispositivo.ip_endereco }}:{{ dispositivo.porta }}</p>
                <p><strong>Ativo:</strong> {{ dispositivo.ativo|yesno:"Sim,Não" }}</p>
                <p><strong>Última Atualização:</strong> {{ dispositivo.ultima_atualizacao|date:"d/m/Y H:i:s" }}</p>

                <h4>Leitura Mais Recente:</h4>
                {% with leitura=leituras_recentes|get_item:dispositivo.id %}
                    {% if leitura %}
                        <p><strong>Temperatura:</strong> {{ leitura.temperatura }}°C</p>
                        <p><strong>Umidade:</strong> {{ leitura.umidade }}%</p>
                        <p><strong>Recebido em:</strong> {{ leitura.timestamp|date:"d/m/Y H:i:s" }}</p>
                    {% else %}
                        <p>Nenhuma leitura recente disponível.</p>
                    {% endif %}
                {% endwith %}

                <h4>Comandos Pendentes:</h4>
                {% with comandos=comandos_pendentes|get_item:dispositivo.id %}
                    {% if comandos %}
                        <ul class="command-list">
                            {% for comando in comandos %}
                                <li>{{ comando.comando }} (Criado em: {{ comando.data_criacao|date:"d/m/Y H:i:s" }})</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Nenhum comando pendente.</p>
                    {% endif %}
                {% endwith %}

                <div class="form-container">
                    <h4>Agendar Novo Comando para {{ dispositivo.nome }}:</h4>
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="device_id" value="{{ dispositivo.id }}">

                        <label for="comando-{{ dispositivo.id }}">Comando (ex: LIGAR_AR, BUZZER_ON):</label>
                        <input type="text" id="comando-{{ dispositivo.id }}" name="comando" required>

                        <label for="parametros-{{ dispositivo.id }}">Parâmetros (JSON opcional, ex: {"temperatura": 22}):</label>
                        <textarea id="parametros-{{ dispositivo.id }}" name="parametros" rows="2" placeholder="{}"></textarea>

                        <button type="submit">Agendar Comando</button>
                    </form>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p>Nenhum dispositivo cadastrado.</p>
    {% endif %}

{% endblock content %} {# <--- FIM DO BLOCO DE CONTEÚDO #}