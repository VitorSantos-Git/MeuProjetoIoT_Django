{# iot_core/templates/iot_core/gerenciar_dispositivos.html #}

{% extends 'base.html' %}
{% load iot_filters %}

{% block title %}Gerenciar Dispositivos IoT{% endblock %}

{% block extra_head %} {# Adicione um pouco de estilo extra para os inputs de data/hora #}
<style>
    .datetime-controls {
        display: flex;
        gap: 10px;
        align-items: flex-end; /* Alinha os inputs e botões na base */
        margin-bottom: 10px;
    }
    .datetime-controls div {
        flex: 1; /* Faz os campos de data/hora ocuparem o mesmo espaço */
    }
    .datetime-controls label {
        margin-bottom: 5px;
    }
    .datetime-controls input[type="date"],
    .datetime-controls input[type="time"] {
        width: calc(100% - 22px); /* Ajuste para preencher o espaço */
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .datetime-controls .buttons {
        display: flex;
        gap: 5px;
    }
    .datetime-controls .buttons button {
        background-color: #007bff; /* Azul para os botões de data/hora */
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
    }
    .datetime-controls .buttons button:hover {
        background-color: #0056b3;
    }
</style>
{% endblock %}

{% block content %}
    <h1>Gerenciar Dispositivos IoT</h1>

    {% if dispositivos %}
        {% for dispositivo in dispositivos %}
            <div class="device-card">
                {# ... (restante do conteúdo da card do dispositivo) ... #}

                <div class="form-container">
                    <h4>Agendar Novo Comando para {{ dispositivo.nome }}:</h4>
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="device_id" value="{{ dispositivo.id }}">

                        <label for="comando-{{ dispositivo.id }}">Comando (ex: LIGAR_AR, BUZZER_ON):</label>
                        <input type="text" id="comando-{{ dispositivo.id }}" name="comando" required>

                        <label for="parametros-{{ dispositivo.id }}">Parâmetros (JSON opcional, ex: {"temperatura": 22}):</label>
                        <textarea id="parametros-{{ dispositivo.id }}" name="parametros" rows="2" placeholder="{}"></textarea>

                        {# NOVOS CAMPOS DE DATA E HORA AQUI #}
                        <div class="datetime-controls">
                            <div>
                                <label for="data-{{ dispositivo.id }}">Data:</label>
                                <input type="date" id="data-{{ dispositivo.id }}" name="data_agendamento" required>
                            </div>
                            <div>
                                <label for="hora-{{ dispositivo.id }}">Hora:</label>
                                <input type="time" id="hora-{{ dispositivo.id }}" name="hora_agendamento" required>
                            </div>
                            <div class="buttons">
                                <button type="button" onclick="setDateTimeNow('{{ dispositivo.id }}')">Hoje | Agora</button>
                            </div>
                        </div>

                        <button type="submit">Agendar Comando</button>
                    </form>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p>Nenhum dispositivo cadastrado.</p>
    {% endif %}
{% endblock content %}

{% block extra_body %} {# Adicionando JavaScript para os botões "Hoje" e "Agora" #}
<script>
    function setDateTimeNow(deviceId) {
        const now = new Date();

        // Formata a data para YYYY-MM-DD
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;

        // Formata a hora para HH:MM
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const timeString = `${hours}:${minutes}`;

        document.getElementById(`data-${deviceId}`).value = dateString;
        document.getElementById(`hora-${deviceId}`).value = timeString;
    }
</script>
{% endblock %}